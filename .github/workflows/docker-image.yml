name: Docker Build, Test and Push

on:
  push:
    branches: [ main ]

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: src

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          cd src
          docker build -t fastp-trimmer:test .

      - name: Run functional tests
        run: |
          cd src
          mkdir -p test-output

          # 检查双端测试数据是否存在
          if [ ! -d "test-data/paired-end" ]; then
            echo "Error: Paired-end test data not found in test-data/paired-end"
            exit 1
          fi

          # 检查单端测试数据是否存在
          if [ ! -d "test-data/single-end" ]; then
            echo "Error: Single-end test data not found in test-data/single-end"
            exit 1
          fi

          # 测试双端数据
          docker run --rm \
            -v $(pwd)/test-data/paired-end:/mnt/in/paired \  # 挂载到容器内的 /mnt/in/paired
            -v $(pwd)/test-output/paired:/mnt/out/paired \    # 挂载到容器内的 /mnt/out/paired
            fastp-trimmer:test

          # 测试单端数据
          docker run --rm \
            -v $(pwd)/test-data/single-end:/mnt/in/single \  # 挂载到容器内的 /mnt/in/single
            -v $(pwd)/test-output/single:/mnt/out/single \    # 挂载到容器内的 /mnt/out/single
            fastp-trimmer:test

          # 验证输出文件
          ls -lh test-output/paired
          ls -lh test-output/single
          [ -f test-output/paired/sample1_R1.fastq.gz ] || exit 1
          [ -f test-output/paired/sample1_fastp.html ] || exit 1
          [ -f test-output/single/sample2.fastq.gz ] || exit 1

      - name: Push to GHCR
        if: success()
        run: |
          cd src
          docker tag fastp-trimmer:test ghcr.io/${{ github.repository_owner }}/fastp-trimmer:${{ github.sha }}
          docker tag fastp-trimmer:test ghcr.io/${{ github.repository_owner }}/fastp-trimmer:latest
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/${{ github.repository_owner }}/fastp-trimmer:${{ github.sha }}
          docker push ghcr.io/${{ github.repository_owner }}/fastp-trimmer:latest
